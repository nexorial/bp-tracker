# Progress Log
Run: b109a6aa-60f4-4b23-ab32-381ddac52867
Task: 开发血压记录工具 BP Tracker
Started: 2026-02-14 12:12 PM

## Codebase Patterns
- This project uses Next.js 15 with App Router
- Tailwind CSS for styling
- Jest + React Testing Library for testing
- SQLite (better-sqlite3) for database
- TypeScript with strict mode enabled
- Tests are excluded from typecheck via tsconfig.json
- Database files (.db) are gitignored

---

## 2026-02-14 12:30 PM - US-001: Initialize Next.js project with TypeScript and Tailwind
- Set up Next.js project with TypeScript and Tailwind CSS
- Installed dependencies: recharts, better-sqlite3, @types/better-sqlite3
- Configured Jest with React Testing Library for testing
- Created smoke tests to verify project setup
- Updated page.tsx with Tailwind test element
- Typecheck passes
- Tests pass (3/3)

**Learnings:**
- Need to exclude __tests__ directory from tsconfig.json for typecheck
- jest-environment-jsdom is required separately as of Jest 28
- Project structure follows Next.js 15 App Router conventions

---

## 2026-02-14 12:23 PM - US-002: Create SQLite database schema for BP records
- Created db/ directory for database files
- Created db/schema.sql with bp_records table:
  - id (INTEGER PRIMARY KEY AUTOINCREMENT)
  - systolic (INTEGER NOT NULL)
  - diastolic (INTEGER NOT NULL)
  - heart_rate (INTEGER NOT NULL)
  - recorded_at (DATETIME DEFAULT CURRENT_TIMESTAMP)
  - notes (TEXT optional)
- Created db/init.ts database initialization script
- Added index on recorded_at for faster queries
- Created comprehensive tests for database schema
- Installed @types/better-sqlite3 for type checking
- Typecheck passes
- Tests pass (8/8 total, 5 new)

**Learnings:**
- better-sqlite3 is synchronous, which works well with Jest tests
- Need @types/better-sqlite3 for TypeScript support
- SQLite PRAGMA commands can verify table structure in tests

---

## 2026-02-14 12:39 PM - US-003: Build database client and CRUD operations
- Created lib/db.ts with BetterSQLite3 client wrapper
- Implemented createRecord() - inserts BP data and returns created record with ID
- Implemented getRecords(limit?, offset?) - returns records ordered by recorded_at DESC with pagination
- Implemented getRecordById(id) - returns single record or null if not found
- Implemented deleteRecord(id) - removes record and returns success boolean
- Added proper TypeScript types: BPRecord, CreateBPRecordInput, PaginationOptions
- Created BPTrackerDatabase class with singleton pattern for app use
- Added createBPTrackerDatabase() factory for testing
- Created comprehensive tests for all CRUD operations (15 tests)
- Typecheck passes
- Build passes
- All tests pass (23/23)

**Learnings:**
- Use `datetime('now', '-N minutes')` for timestamp manipulation in SQLite tests
- SQLite CURRENT_TIMESTAMP stores as UTC; use `.getTime()` for comparisons
- better-sqlite3 is synchronous, works well with Jest synchronous tests
- (db as any).db pattern allows direct access to underlying db for test setup

---

## 2026-02-14 12:55 PM - US-004: Implement BP input parser for 120/80/72 format
- Created lib/parser.ts with parseBPInput function
- Supports '120/80/72' format with heart rate and '120/80' without
- Validates ranges: systolic 60-250, diastolic 40-150, heart rate 40-200
- Returns discriminated union: { success: true, data } or { success: false, errors }
- Handles whitespace trimming from input values
- Created 21 comprehensive tests covering valid inputs, invalid formats, range validation, and edge cases
- Typecheck passes
- Build passes
- All tests pass (44/44)

**Learnings:**
- Use TypeScript discriminated unions with success flag for type-safe result handling
- parseInt truncates decimals, which is acceptable for BP values

---

## 2026-02-14 1:58 PM - US-005: Create API endpoint for adding BP records
- Created app/api/records/route.ts with POST handler
- Accepts both string format ({ input: '120/80/72' }) and object format ({ systolic, diastolic, heartRate })
- Validates data using parser ranges for both formats
- Stores in database using db.createRecord
- Returns 201 with created record including ID and timestamp
- Returns 400 with descriptive error messages for invalid data
- Created 19 comprehensive API tests covering:
  - String format input (with/without heart rate, with notes)
  - Object format input (valid, with notes, missing fields)
  - Validation errors (out of range values, invalid format)
  - Edge cases (boundary values, empty body, null body, auto-incrementing IDs, timestamps)
- Updated jest.setup.js to add Request/Response mocks for API testing
- Typecheck passes
- Build passes
- All tests pass (63/63)

**Learnings:**
- Next.js App Router API routes need Request/Response globals in Jest (jsdom doesn't have them)
- Mock Response needs static json() method for NextResponse.json() to work
- Always validate body is an object before accessing properties (handle null/undefined)

---

## 2026-02-14 4:07 PM - US-006: Create API endpoint for fetching BP records
- Extended app/api/records/route.ts with GET handler
- Support query params: limit (default 50), offset (default 0), days (filter last N days)
- Updated lib/db.ts getRecords() to return {records, total} with days filtering support
- Changed default limit from 100 to 50 for better performance
- Added resetBPTrackerDatabase() for test isolation
- Added RecordsResult interface for typed return values
- Records ordered by recorded_at DESC (newest first)
- Response includes records array and total count for pagination
- Added comprehensive validation for query parameters (limit, offset, days)
- Created 21 new API tests for GET endpoint:
  - Basic retrieval (empty, ordering, structure)
  - Pagination (limit, offset, defaults)
  - Days filter (7 days, 3 days, combined with limit)
  - Validation (invalid limit, offset, days values)
- Updated db-client tests to work with new getRecords return type
- Fixed API test mocking strategy using jest.mock at module level
- Typecheck passes
- Build passes
- All 84 tests pass

**Learnings:**
- Use jest.mock at module level (top of file) to properly mock modules in Jest
- Mocked functions need jest.clearAllMocks() in afterEach for isolation
- better-sqlite3 supports datetime('now', '-N days') for date filtering
- Return total count alongside records for frontend pagination UI
- Default limit of 50 is reasonable for BP tracking app

---

## 2026-02-14 5:17 PM - US-007: Build main dashboard layout with Tailwind
- Updated app/page.tsx with responsive dashboard layout
- Created header with app title 'BP Tracker' and description
- Implemented mobile-first responsive grid layout:
  - Chart section: full width on mobile, 2/3 on large screens
  - Input section: full width on mobile, 1/3 on large screens
  - Records list: full width on all screens
- Used Tailwind CSS for all styling (colors, spacing, typography, shadows)
- Created __tests__/dashboard.test.tsx with 8 tests covering layout rendering and Tailwind classes
- Updated smoke.test.tsx to work with new dashboard layout
- All sections have placeholder content ready for next stories
- Typecheck passes
- Build passes
- All 92 tests pass

**Learnings:**
- Use Tailwind's responsive prefixes (sm:, lg:) for mobile-first design
- max-w-7xl with mx-auto creates a centered content container
- Use data-testid for testing specific elements without relying on text content
- Placeholder divs with bg-gray-100 help visualize layout during development

---

## 2026-02-14 6:15 PM - US-008: Create BP trend chart with Recharts
- Created app/components/BPChart.tsx with Recharts LineChart component
- Display three lines: systolic (red #dc2626), diastolic (blue #2563eb), heart rate (green #16a34a)
- X-axis shows dates, Y-axis shows values with auto-scaling domain
- Included Legend with formatted labels (Systolic, Diastolic, Heart Rate)
- Tooltips show formatted values on hover with styled container
- Empty state displays 'No data available' message with gray styling
- Created comprehensive tests in __tests__/bpchart.test.tsx (16 tests):
  - Rendering tests for chart, axes, grid, tooltip, legend
  - Line color verification tests
  - Empty state handling
  - Data variation tests (single point, many points)
- Mocked Recharts components in tests to avoid SVG rendering issues
- Added ResizeObserver mock to jest.setup.js for Recharts compatibility
- Updated dashboard test to check for BPChart component instead of placeholder
- Integrated BPChart into page.tsx with sample data
- Typecheck passes
- All 105 tests pass

**Learnings:**
- Recharts requires ResizeObserver mock in Jest tests (jsdom doesn't have it)
- Mock Recharts components at test level to avoid SVG/ResponsiveContainer issues
- Use 'use client' directive for components using Recharts
- ResponsiveContainer needs a parent with defined height, use h-64 class
- Recharts formatter functions can transform display names for legend/tooltip
